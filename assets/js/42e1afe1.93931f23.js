(self.webpackChunkweb=self.webpackChunkweb||[]).push([[6033],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),m=i,h=c["".concat(l,".").concat(m)]||c[m]||u[m]||o;return n?a.createElement(h,r(r({ref:t},d),{},{components:n})):a.createElement(h,r({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},3523:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return d},default:function(){return c}});var a=n(2122),i=n(9756),o=(n(7294),n(3905)),r=["components"],s={title:"Features"},l=void 0,p={unversionedId:"language/features",id:"language/features",isDocsHomePage:!1,title:"Features",description:"App",source:"@site/docs/language/features.md",sourceDirName:"language",slug:"/language/features",permalink:"/docs/language/features",editUrl:"https://github.com/wasp-lang/wasp/edit/main/web/docs/language/features.md",tags:[],version:"current",frontMatter:{title:"Features"},sidebar:"docs",previous:{title:"Syntax",permalink:"/docs/language/syntax"},next:{title:"CLI Reference",permalink:"/docs/cli"}},d=[{value:"App",id:"app",children:[{value:"Fields",id:"fields",children:[]}]},{value:"Page",id:"page",children:[{value:"Fields",id:"fields-1",children:[]}]},{value:"Route",id:"route",children:[{value:"Fields",id:"fields-2",children:[]},{value:"Example - parametrised URL path",id:"example---parametrised-url-path",children:[]},{value:"Accessing route parameters in a page component",id:"accessing-route-parameters-in-a-page-component",children:[]},{value:"Navigating between routes",id:"navigating-between-routes",children:[]}]},{value:"Entity",id:"entity",children:[{value:"<code>{=psl ... psl=}: PSL</code>",id:"psl--psl-psl",children:[]},{value:"Using Entities",id:"using-entities",children:[]}]},{value:"Queries and Actions (aka Operations)",id:"queries-and-actions-aka-operations",children:[{value:"Query",id:"query",children:[]},{value:"Action",id:"action",children:[]},{value:"Cache Invalidation",id:"cache-invalidation",children:[]},{value:"Prisma Error Helpers",id:"prisma-error-helpers",children:[]}]},{value:"Jobs",id:"jobs",children:[{value:"Job Executors",id:"job-executors",children:[]},{value:"Basic job definition and usage",id:"basic-job-definition-and-usage",children:[]},{value:"Recurring jobs",id:"recurring-jobs",children:[]},{value:"Fully specified example",id:"fully-specified-example",children:[]},{value:"Fields",id:"fields-3",children:[]},{value:"JavaScript API",id:"javascript-api",children:[]}]},{value:"Dependencies",id:"dependencies",children:[]},{value:"Authentication &amp; Authorization",id:"authentication--authorization",children:[{value:"Email and Password",id:"email-and-password",children:[]},{value:"<code>login()</code>",id:"login",children:[]},{value:"<code>signup()</code>",id:"signup",children:[]},{value:"<code>logout()</code>",id:"logout",children:[]},{value:"Updating user&#39;s password",id:"updating-users-password",children:[]},{value:"Accessing currently logged in user",id:"accessing-currently-logged-in-user",children:[]},{value:"<code>useAuth()</code>",id:"useauth",children:[]},{value:"Validation Error Handling",id:"validation-error-handling",children:[]}]},{value:"Client configuration",id:"client-configuration",children:[]},{value:"Server configuration",id:"server-configuration",children:[]},{value:".env",id:"env",children:[]},{value:"Database configuration",id:"database-configuration",children:[{value:"SQLite",id:"sqlite",children:[]},{value:"PostgreSQL",id:"postgresql",children:[]},{value:"Migrating from SQLite to PostgreSQL",id:"migrating-from-sqlite-to-postgresql",children:[]}]}],u={toc:d};function c(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"app"},"App"),(0,o.kt)("p",null,"There can be only one declaration of ",(0,o.kt)("inlineCode",{parentName:"p"},"app")," type per Wasp project.\nIt serves as a starting point and defines global properties of your app."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css"},'app todoApp {\n  title: "ToDo App",\n  head: [  // optional\n    "<link rel=\\"stylesheet\\" href=\\"https://fonts.googleapis.com/css?family=Roboto:300,400,500&display=swap\\" />"\n  ]\n}\n')),(0,o.kt)("h3",{id:"fields"},"Fields"),(0,o.kt)("h4",{id:"title-string-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"title: string")," (required)"),(0,o.kt)("p",null,"Title of your app. It will be displayed in the browser tab, next to the favicon."),(0,o.kt)("h4",{id:"head-string-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"head: [string]")," (optional)"),(0,o.kt)("p",null,"Head of your HTML Document. Your app's metadata (styles, links, etc) can be added here."),(0,o.kt)("h4",{id:"auth-dict-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"auth: dict")," (optional)"),(0,o.kt)("p",null,"Authentication and authorization configuration.\nCheck ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#authentication--authorization"},(0,o.kt)("inlineCode",{parentName:"a"},"app.auth"))," for more details."),(0,o.kt)("h4",{id:"client-dict-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"client: dict")," (optional)"),(0,o.kt)("p",null,"Client configuration.\nCheck ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#client-configuration"},(0,o.kt)("inlineCode",{parentName:"a"},"app.client"))," for more details."),(0,o.kt)("h4",{id:"server-dict-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"server: dict")," (optional)"),(0,o.kt)("p",null,"Server configuration.\nCheck ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#server-configuration"},(0,o.kt)("inlineCode",{parentName:"a"},"app.server"))," for more details."),(0,o.kt)("h4",{id:"db-dict-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"db: dict")," (optional)"),(0,o.kt)("p",null,"Database configuration.\nCheck ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#database-configuration"},(0,o.kt)("inlineCode",{parentName:"a"},"app.db"))," for more details."),(0,o.kt)("h4",{id:"dependencies-string-string-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"dependencies: [(string, string)]")," (optional)"),(0,o.kt)("p",null,"List of dependencies (external libraries).\nCheck ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#dependencies"},(0,o.kt)("inlineCode",{parentName:"a"},"app.dependencies"))," for more details."),(0,o.kt)("h2",{id:"page"},"Page"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"page")," declaration is the top-level layout abstraction. Your app can have multiple pages."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css"},'page MainPage {\n  component: import Main from "@ext/pages/Main",\n  authRequired: false  // optional\n}\n')),(0,o.kt)("p",null,"Normally you will also want to associate ",(0,o.kt)("inlineCode",{parentName:"p"},"page")," with a ",(0,o.kt)("inlineCode",{parentName:"p"},"route"),", otherwise it won't be accessible in the app."),(0,o.kt)("h3",{id:"fields-1"},"Fields"),(0,o.kt)("h4",{id:"component-extimport-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"component: ExtImport")," (required)"),(0,o.kt)("p",null,"Import statement of the React element that implements the page component.\nSee importing external code for details."),(0,o.kt)("h4",{id:"authrequired-bool-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"authRequired: bool")," (optional)"),(0,o.kt)("p",null,"Can be specified only if ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#authentication--authorization"},(0,o.kt)("inlineCode",{parentName:"a"},"app.auth"))," is defined."),(0,o.kt)("p",null,"If set to ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),", only authenticated users will be able to access this page. Unauthenticated users will be redirected to a route defined by ",(0,o.kt)("inlineCode",{parentName:"p"},"onAuthFailedRedirectTo")," property within ",(0,o.kt)("inlineCode",{parentName:"p"},"app.auth"),"."),(0,o.kt)("p",null,"If ",(0,o.kt)("inlineCode",{parentName:"p"},"authRequired")," is set to ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),", the React component of a page (specified by ",(0,o.kt)("inlineCode",{parentName:"p"},"component")," property) will be provided ",(0,o.kt)("inlineCode",{parentName:"p"},"user")," object as a prop."),(0,o.kt)("p",null,"Check out this ",(0,o.kt)("a",{parentName:"p",href:"/docs/tutorials/todo-app/auth#updating-main-page-to-check-if-user-is-authenticated"},"section of our Todo app tutorial")," for an example of usage."),(0,o.kt)("h2",{id:"route"},"Route"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"route")," declaration provides top-level routing functionality in Wasp."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css"},'route AboutRoute { path: "/about", to: AboutPage }\n')),(0,o.kt)("h3",{id:"fields-2"},"Fields"),(0,o.kt)("h4",{id:"path-string-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"path: string")," (required)"),(0,o.kt)("p",null,"URL path of the route. Route path can be parametrised and follows the same conventions as\n",(0,o.kt)("a",{parentName:"p",href:"https://reactrouter.com/web/"},"React Router"),"."),(0,o.kt)("h4",{id:"to-page-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"to: page")," (required)"),(0,o.kt)("p",null,"Name of the ",(0,o.kt)("inlineCode",{parentName:"p"},"page")," to which the path will lead.\nReferenced page must be defined somewhere in ",(0,o.kt)("inlineCode",{parentName:"p"},".wasp")," file."),(0,o.kt)("h3",{id:"example---parametrised-url-path"},"Example - parametrised URL path"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css"},'route TaskRoute { path: "/task/:id", to: TaskPage }\n')),(0,o.kt)("p",null,"For details on URL path format check ",(0,o.kt)("a",{parentName:"p",href:"https://reactrouter.com/web/"},"React Router"),"\ndocumentation."),(0,o.kt)("h3",{id:"accessing-route-parameters-in-a-page-component"},"Accessing route parameters in a page component"),(0,o.kt)("p",null,"Since Wasp under the hood generates code with ",(0,o.kt)("a",{parentName:"p",href:"https://reactrouter.com/web/"},"React Router"),",\nthe same rules apply when accessing URL params in your React components. Here is an example just to get you\nstarted:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c",metastring:'title="todoApp.wasp"',title:'"todoApp.wasp"'},'// ...\nroute TaskRoute { path: "/task/:id", to: TaskPage }\npage TaskPage {\n  component: import Task from "@ext/pages/Task"\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="pages/Task.js"',title:'"pages/Task.js"'},"import React from 'react'\n\nconst Task = (props) => {\n  return (\n    <div>\n      I am showing a task with id: {props.match.params.id}.\n    </div>\n  )\n}\n\nexport default Task\n")),(0,o.kt)("h3",{id:"navigating-between-routes"},"Navigating between routes"),(0,o.kt)("p",null,"Navigation can be performed from the React code via ",(0,o.kt)("inlineCode",{parentName:"p"},"<Link/>")," component, also using the functionality of\n",(0,o.kt)("a",{parentName:"p",href:"https://reactrouter.com/web/"},"React Router"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c",metastring:'title="todoApp.wasp"',title:'"todoApp.wasp"'},'// ...\nroute HomeRoute { path: "/home", to: HomePage }\npage HomePage {\n  component: import Home from "@ext/pages/Home"\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="pages/OtherPage.js"',title:'"pages/OtherPage.js"'},'import React from \'react\'\nimport { Link } from "react-router-dom"\n\nconst OtherPage = (props) => {\n  return (\n    <Link to="/home">Go to homepage</Link>\n  )\n}\n')),(0,o.kt)("h2",{id:"entity"},"Entity"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"entity")," declaration represents a database model.\nWasp uses ",(0,o.kt)("a",{parentName:"p",href:"https://www.prisma.io/"},"Prisma")," to implement database functionality and currently provides only a thin layer above it."),(0,o.kt)("p",null,"Each ",(0,o.kt)("inlineCode",{parentName:"p"},"Entity")," declaration corresponds 1-to-1 to Prisma data model and is defined in a following way:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css"},"entity Task {=psl\n    id          Int     @id @default(autoincrement())\n    description String\n    isDone      Boolean @default(false)\npsl=}\n")),(0,o.kt)("h3",{id:"psl--psl-psl"},(0,o.kt)("inlineCode",{parentName:"h3"},"{=psl ... psl=}: PSL")),(0,o.kt)("p",null,"Definition of entity fields in ",(0,o.kt)("em",{parentName:"p"},"Prisma Schema Language")," (PSL). See\n",(0,o.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-schema"},"here for intro and examples"),"\nand ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/prisma/specs/tree/master/schema"},"here for a more exhaustive language specification"),"."),(0,o.kt)("h3",{id:"using-entities"},"Using Entities"),(0,o.kt)("p",null,"Entity-system in Wasp is based on ",(0,o.kt)("a",{parentName:"p",href:"http://www.prisma.io"},"Prisma"),", and currently Wasp provides only a thin layer\non top of it. The workflow is as follows:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Wasp developer creates/updates some of the entities in ",(0,o.kt)("inlineCode",{parentName:"li"},".wasp")," file."),(0,o.kt)("li",{parentName:"ol"},"Wasp developer runs ",(0,o.kt)("inlineCode",{parentName:"li"},"wasp db migrate-dev"),"."),(0,o.kt)("li",{parentName:"ol"},"Migration data is generated in ",(0,o.kt)("inlineCode",{parentName:"li"},"migrations/")," folder (and should be commited)."),(0,o.kt)("li",{parentName:"ol"},"Wasp developer uses Prisma JS API to work with the database when in Operations.")),(0,o.kt)("p",null,"Currently entities can be accessed only in Operations (Queries & Actions), so check their part of docs for more info on how to use entities in their context."),(0,o.kt)("h2",{id:"queries-and-actions-aka-operations"},"Queries and Actions (aka Operations)"),(0,o.kt)("p",null,"In Wasp, the client and the server interact with each other through Operations.\nWasp currently supports two kinds of Operations: ",(0,o.kt)("strong",{parentName:"p"},"Queries")," and ",(0,o.kt)("strong",{parentName:"p"},"Actions"),"."),(0,o.kt)("h3",{id:"query"},"Query"),(0,o.kt)("p",null,"Queries are used to fetch data from the server. They do not modify the server's state."),(0,o.kt)("p",null,"Queries are implemented in NodeJS and executed within the server's context.\nWasp generates the code that lets you call the Query from anywhere in your code (client or server) using the same interface.\nIn other words, you won't have to worry about building an HTTP API for the Query, handling the request on the server, or even handling and caching the responses on the client.\nInstead, simply focus on the business logic inside your Query and let Wasp take care of the rest!"),(0,o.kt)("p",null,"To create a Wasp Query, you must:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Define the Query's NodeJS implementation"),(0,o.kt)("li",{parentName:"ol"},"Declare the Query in Wasp using the ",(0,o.kt)("inlineCode",{parentName:"li"},"query")," declaration")),(0,o.kt)("p",null,"After completing these two steps, you'll be able to use the Query from any point in your code."),(0,o.kt)("h4",{id:"defining-the-querys-nodejs-implementation"},"Defining the Query's NodeJS implementation"),(0,o.kt)("p",null,"A Query must be implemented as an ",(0,o.kt)("inlineCode",{parentName:"p"},"async")," NodeJS function that takes two arguments.\nSince both arguments are positional, you can name the parameters however you want, but we'll stick with ",(0,o.kt)("inlineCode",{parentName:"p"},"args")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"context"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"args"),":  An object containing all the arguments (i.e., payload) ",(0,o.kt)("strong",{parentName:"li"},"passed to the Query by the caller")," (e.g., filtering conditions).\nTake a look at ",(0,o.kt)("a",{parentName:"li",href:"#using-the-query"},"the examples of usage")," to see how to pass this object to the Query."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"context"),": An additional context object ",(0,o.kt)("strong",{parentName:"li"},"injected into the Query by Wasp"),". This object contains user session information, as well as information about entities. The examples here won't use the context for simplicity purposes. You can read more about it in the ",(0,o.kt)("a",{parentName:"li",href:"#using-entities-in-queries"},"section about using entities in queries"),".")),(0,o.kt)("p",null,"Here's an example of two simple Queries:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="ext/queries.js"',title:'"ext/queries.js"'},'// our "database"\nconst tasks = [\n  { id: 1, description: "Buy some eggs", isDone: true },\n  { id: 2, description: "Make an omelette", isDone: false },\n  { id: 3, description: "Eat breakfast", isDone: false }\n]\n\n\n// You don\'t need to use the arguments if you don\'t need them\nexport const getAllTasks = async () => {\n  return tasks;\n}\n\n// The \'args\' object is something sent by the caller (most often from the client)\nexport const getFilteredTasks = async (args) => {\n  const { isDone } = args;\n  return tasks.filter(task => task.isDone === isDone)\n}\n')),(0,o.kt)("h4",{id:"declaring-a-query-in-wasp"},"Declaring a Query in Wasp"),(0,o.kt)("p",null,"After implementing your Queries in NodeJS, all that's left to do before using them is tell Wasp about it!\nYou can easily do this with the ",(0,o.kt)("inlineCode",{parentName:"p"},"query")," declaration, which supports the following fields:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"fn: ExtImport")," (required) - The import statement of the Query's NodeJs implementation."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"entities: [Entity]")," (optional) - A list of entities you wish to use inside your Query.\nWe'll leave this option aside for now. You can read more about it ",(0,o.kt)("a",{parentName:"li",href:"#using-entities-in-queries"},"here"),".")),(0,o.kt)("p",null,"Wasp Queries and their implementations don't need to (but can) have the same name, so we will keep the names different to avoid confusion.\nWith that in mind, this is how you might declare the Queries that use the implementations from the previous step:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c",metastring:'title="main.wasp"',title:'"main.wasp"'},'// ...\n\n// Again, it most likely makes sense to name the Wasp Query after\n// its implementation. We\'re changing the name to emphasize the difference.\n\nquery fetchAllTasks {\n  fn: import { getAllTasks } from "@ext/queries.js"\n}\n\nquery fetchFilteredTasks {\n  fn: import { getFilteredTasks } from "@ext/queries.js"\n}\n')),(0,o.kt)("p",null,"After declaring a NodeJS function as a Wasp Query, two crucial things happen:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Wasp ",(0,o.kt)("strong",{parentName:"li"},"generates a client-side JavaScript function")," that shares its name with the Query (e.g., ",(0,o.kt)("inlineCode",{parentName:"li"},"fetchFilteredTasks"),").\nThis function takes a single optional argument - an object containing any serializable data you wish to use inside the Query.\nWasp will pass this object to the Query's implementation as its first positional argument (i.e., ",(0,o.kt)("inlineCode",{parentName:"li"},"args")," from the previous step).\nSuch an abstraction works thanks to an HTTP API route handler Wasp generates on the server, which calls the Query's NodeJS implementation under the hood."),(0,o.kt)("li",{parentName:"ul"},"Wasp ",(0,o.kt)("strong",{parentName:"li"},"generates a server-side NodeJS function")," that shares its name with the Query. This function's interface is identical to the client-side function from the previous point.")),(0,o.kt)("p",null,"Generating two such functions ensures a uniform calling interface across the entire app (both client and server)."),(0,o.kt)("h4",{id:"using-the-query"},"Using the Query"),(0,o.kt)("p",null,"To use the Query, you can import it from ",(0,o.kt)("inlineCode",{parentName:"p"},"@wasp")," and call it directly. As mentioned, the usage is the same regardless of whether you're on the server or the client:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"import fetchAllTasks from '@wasp/queries/fetchAllTasks.js'\nimport fetchFilteredTasks from '@wasp/queries/fetchFilteredTasks.js'\n\n// ...\n\nconst allTasks = await fetchAllTasks();\nconst doneTasks = await fetchFilteredTasks({isDone: true})\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"NOTE"),": Wasp will not stop you from importing a Query's NodeJS implementation from ",(0,o.kt)("inlineCode",{parentName:"p"},"./queries.js")," and calling it directly. However, we advise against this, as you'll lose all the useful features a Wasp Query provides (e.g., entity injection)."),(0,o.kt)("h4",{id:"the-usequery-hook"},"The ",(0,o.kt)("inlineCode",{parentName:"h4"},"useQuery")," hook"),(0,o.kt)("p",null,"When using Queries on the client, you can make them reactive with the help of the ",(0,o.kt)("inlineCode",{parentName:"p"},"useQuery")," hook.\nThis hook comes bundled with Wasp and is a thin wrapper around the ",(0,o.kt)("inlineCode",{parentName:"p"},"useQuery")," hook from ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/tannerlinsley/react-query"},(0,o.kt)("em",{parentName:"a"},"react-query")),"."),(0,o.kt)("p",null,"Wasp's ",(0,o.kt)("inlineCode",{parentName:"p"},"useQuery")," hook accepts three arguments:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"queryFn")," (required): A Wasp query declared in the previous step or, in other words, the client-side query function generated by Wasp based on a ",(0,o.kt)("inlineCode",{parentName:"li"},"query")," declaration."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"queryFnArgs")," (optional): The arguments object (payload) you wish to pass into the query. The query's NodeJS implementation will receive this object as its first positional argument."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"config")," (optional): A ",(0,o.kt)("em",{parentName:"li"},"react-query")," ",(0,o.kt)("inlineCode",{parentName:"li"},"config")," object.")),(0,o.kt)("p",null,"Wasp's ",(0,o.kt)("inlineCode",{parentName:"p"},"useQuery")," hook behaves mostly the same as ",(0,o.kt)("a",{parentName:"p",href:"https://react-query.tanstack.com/docs/api#usequery"},(0,o.kt)("em",{parentName:"a"},"react-query"),"'s ",(0,o.kt)("inlineCode",{parentName:"a"},"useQuery")," hook"),", the only difference being in not having to supply the key (Wasp does this automatically under the hood)."),(0,o.kt)("p",null,"Here's an example of calling the Queries using the ",(0,o.kt)("inlineCode",{parentName:"p"},"useQuery")," hook:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},"import React from 'react'\nimport { useQuery } from '@wasp/queries'\n\nimport fetchAllTasks from '@wasp/queries/fetchAllTasks'\nimport fetchFilteredTasks from '@wasp/queries/fetchFilteredTasks'\n\n\n\nconst MainPage = () => {\n  const {\n    data: allTasks,\n    error: error1\n  } = useQuery(fetchAllTasks)\n\n  const {\n    data: doneTasks,\n    error: error2\n  } = useQuery(fetchFilteredTasks, { isDone: true })\n\n  return (\n    <div>\n        <p>All tasks: { JSON.stringify(allTasks || error1) }</p>\n        <p>Finished tasks: { JSON.stringify(doneTasks || error2) }</p>\n    </div>\n  )\n}\n\nexport default MainPage\n")),(0,o.kt)("h4",{id:"error-handling"},"Error Handling"),(0,o.kt)("p",null,"For security reasons, all exceptions thrown in the Query's NodeJS implementation are sent to the client as responses with the HTTP status code ",(0,o.kt)("inlineCode",{parentName:"p"},"500"),", with all other details removed.\nHiding error details by default helps against accidentally leaking possibly sensitive information over the network."),(0,o.kt)("p",null,"If you do want to pass additional error information to the client, you can construct and throw an appropriate ",(0,o.kt)("inlineCode",{parentName:"p"},"HttpError")," in your NodeJS Query function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"title=ext/queries.js",title:"ext/queries.js"},"import HttpError from '@wasp/core/HttpError.js'\n\nexport const getTasks = async (args, context) => {\n  const statusCode = 403\n  const message = 'You can\\'t do this!'\n  const data = { foo: 'bar' }\n  throw new HttpError(statusCode, message, data)\n}\n")),(0,o.kt)("p",null,"If the status code is ",(0,o.kt)("inlineCode",{parentName:"p"},"4xx"),", the client will receive a response object with the corresponding ",(0,o.kt)("inlineCode",{parentName:"p"},".message")," and ",(0,o.kt)("inlineCode",{parentName:"p"},".data")," fields and rethrow the error (with these fields included).\nTo prevent information leakage, the server won't forward these fields for any other HTTP status codes."),(0,o.kt)("h4",{id:"using-entities-in-queries"},"Using Entities in Queries"),(0,o.kt)("p",null,"In most cases, resources used in Queries will be ",(0,o.kt)("a",{parentName:"p",href:"#entity"},"Entities"),".\nTo use an Entity in your Query, add it to the query declaration in Wasp:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c",metastring:'{4,9} title="main.wasp"',"{4,9}":!0,title:'"main.wasp"'},'\nquery fetchAllTasks {\n  fn: import { getAllTasks } from "@ext/queries.js",\n  entities: [Task]\n}\n\nquery fetchFilteredTasks {\n  fn: import { getFilteredTasks } from "@ext/queries.js",\n  entities: [Task]\n}\n')),(0,o.kt)("p",null,"Wasp will inject the specified Entity into the Query's ",(0,o.kt)("inlineCode",{parentName:"p"},"context")," argument, giving you access to the Entity's Prisma API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="ext/queries.js"',title:'"ext/queries.js"'},"// ...\n\nexport const getAllTasks = async (args, context) => {\n  return context.entities.Task.findMany({})\n}\n\nexport const getFilteredTasks = async (args, context) => {\n  return context.entities.Task.findMany({\n    where: { isDone: args.isDone }\n  })\n}\n")),(0,o.kt)("p",null,"The object ",(0,o.kt)("inlineCode",{parentName:"p"},"context.entities.Task")," exposes ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma.task")," from ",(0,o.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-client/crud"},"Prisma's CRUD API"),"."),(0,o.kt)("h3",{id:"action"},"Action"),(0,o.kt)("p",null,"Actions are very similar to Queries. So similar, in fact, we will only list the differences:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"They can (and most often should) modify the server's state, while Queries are only allowed to read it."),(0,o.kt)("li",{parentName:"ol"},"Since Actions don't need to be reactive, Wasp doesn't provide a React hook for them (like ",(0,o.kt)("inlineCode",{parentName:"li"},"useQuery")," for Queries) - you just call them directly."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"action")," declarations in Wasp are mostly identical to ",(0,o.kt)("inlineCode",{parentName:"li"},"query")," declarations. The only difference is in the declaration's name.")),(0,o.kt)("p",null,"Here's an implementation of a simple Action:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"title=actions.js",title:"actions.js"},"export const sayHi = async () => {\n  console.log('The client said Hi!')\n}\n")),(0,o.kt)("p",null,"Its corresponding declaration in Wasp:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c",metastring:'title="main.wasp"',title:'"main.wasp"'},'// ...\n\naction sayHi {\n  fn: import { sayHi } from "@ext/actions.js"\n}\n')),(0,o.kt)("p",null,"And an example of how to import and call the declared Action:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import sayHi from '@wasp/actions/sayHi'\n\n// ...\n\nsayHi()\n")),(0,o.kt)("p",null,"More differences and Action/Query specific features will come in future versions of Wasp."),(0,o.kt)("h3",{id:"cache-invalidation"},"Cache Invalidation"),(0,o.kt)("p",null,"One of the trickiest parts of managing a web app's state is making sure the data returned by the queries is up to date.\nSince Wasp uses ",(0,o.kt)("em",{parentName:"p"},"react-query")," for Query management, we must make sure to invalidate Queries (more specifically, their cached results managed by ",(0,o.kt)("em",{parentName:"p"},"react-query"),") whenever they become stale."),(0,o.kt)("p",null,"It's possible to invalidate the caches manually through several mechanisms ",(0,o.kt)("em",{parentName:"p"},"react-query")," provides (e.g., refetch, direct invalidation).\nHowever, since manual cache invalidation quickly becomes complex and error-prone, Wasp offers a quicker and a more effective solution to get you started: ",(0,o.kt)("strong",{parentName:"p"},"automatic Entity-based Query cache invalidation"),".\nBecause Actions can (and most often do) modify the state while Queries read it, Wasp invalidates a Query's cache whenever an Action that uses the same Entity is executed."),(0,o.kt)("p",null,"For example, let's assume that Action ",(0,o.kt)("inlineCode",{parentName:"p"},"createTask")," and Query ",(0,o.kt)("inlineCode",{parentName:"p"},"getTasks")," both use Entity ",(0,o.kt)("inlineCode",{parentName:"p"},"Task"),". If ",(0,o.kt)("inlineCode",{parentName:"p"},"createTask")," is executed, ",(0,o.kt)("inlineCode",{parentName:"p"},"getTasks"),"'s cached result may no longer be up-to-date.\nWasp will therefore invalidate it, making ",(0,o.kt)("inlineCode",{parentName:"p"},"getTasks")," refetch data from the server, bringing it up to date again."),(0,o.kt)("p",null,'In practice, this means that Wasp keeps the queries "fresh" without requiring you to think about cache invalidation.'),(0,o.kt)("p",null,"On the other hand, this kind of automatic cache invalidation can become wasteful (some updates might not be necessary) and will only work for Entities. If that's an issue, you can use the mechanisms provided by ",(0,o.kt)("em",{parentName:"p"},"react-query")," for now, and expect more direct support in Wasp for handling those use cases in a nice, elegant way."),(0,o.kt)("h3",{id:"prisma-error-helpers"},"Prisma Error Helpers"),(0,o.kt)("p",null,"In your Operations, you may wish to handle general Prisma errors with HTTP-friendly responses. We have exposed two helper functions, ",(0,o.kt)("inlineCode",{parentName:"p"},"isPrismaError"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"prismaErrorToHttpError"),", for this purpose. As of now, we convert two specific Prisma errors (which we will continue to expand), with the rest being ",(0,o.kt)("inlineCode",{parentName:"p"},"500"),". See the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/main/waspc/e2e-test/test-outputs/waspMigrate-golden/waspMigrate/.wasp/out/server/src/utils.js"},"source here"),"."),(0,o.kt)("h4",{id:"import-statement"},(0,o.kt)("inlineCode",{parentName:"h4"},"import statement"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import { isPrismaError, prismaErrorToHttpError } from '@wasp/utils.js'\n")),(0,o.kt)("h5",{id:"example-of-usage"},"Example of usage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  try {\n    await context.entities.Task.create({...})\n  } catch (e) {\n    if (isPrismaError(e)) {\n      throw prismaErrorToHttpError(e)\n    } else {\n      throw e\n    }\n  }\n")),(0,o.kt)("h2",{id:"jobs"},"Jobs"),(0,o.kt)("p",null,"If you have server tasks that you do not want to handle as part of the normal request-response cycle, Wasp allows you to make that function a ",(0,o.kt)("inlineCode",{parentName:"p"},"job"),' and it will gain some "superpowers." Jobs will persist between server restarts, can be retried if they fail, and they can even be delayed until the future (or have a recurring schedule)! Some examples where you may want to use a ',(0,o.kt)("inlineCode",{parentName:"p"},"job")," on the server include sending an email, making an HTTP request to some external API, or doing some nightly calculations."),(0,o.kt)("h3",{id:"job-executors"},"Job Executors"),(0,o.kt)("p",null,"Job executors handle the scheduling, monitoring, and execution of our jobs."),(0,o.kt)("p",null,"Wasp allows you to choose which job executor will be used to execute a specific job that you define, which affects some of the finer details of how jobs will behave and how they can be further configured. Each job executor has its pros and cons, which we will explain in more detail below, so you can pick the one that best suits your needs."),(0,o.kt)("p",null,"Currently, Wasp supports only one type of job executor, which is ",(0,o.kt)("inlineCode",{parentName:"p"},"PgBoss"),", but in the future, it will likely support more."),(0,o.kt)("h4",{id:"pg-boss"},"pg-boss"),(0,o.kt)("p",null,"We have selected ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/timgit/pg-boss/"},"pg-boss")," as our first job executor to handle the low-volume, basic job queue workloads many web applications have. By using PostgreSQL (and ",(0,o.kt)("a",{parentName:"p",href:"https://www.2ndquadrant.com/en/blog/what-is-select-skip-locked-for-in-postgresql-9-5/"},"SKIP LOCKED"),") as its storage and synchronization mechanism, it allows us to provide many job queue pros without any additional infrastructure or complex management."),(0,o.kt)("p",null,"Keep in mind that pg-boss jobs run alongside your other server-side code, so they are not appropriate for CPU-heavy workloads. Additionally, some care is required if you modify scheduled jobs. Please see pg-boss details for more information."),(0,o.kt)("details",null,(0,o.kt)("summary",null,"pg-boss details"),(0,o.kt)("p",null,"  pg-boss provides many useful features, which can be found ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/timgit/pg-boss/blob/7.2.1/README.md"},"here"),"."),(0,o.kt)("p",null,"  When you add pg-boss to a Wasp project, it will automatically add a new schema to your database called ",(0,o.kt)("inlineCode",{parentName:"p"},"pgboss")," with some internal tracking tables, including ",(0,o.kt)("inlineCode",{parentName:"p"},"job")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"schedule"),". pg-boss tables have a ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," column in most tables that will correspond to your ",(0,o.kt)("inlineCode",{parentName:"p"},"job")," identifier. Additionally, these tables maintain arguments, states, return values, retry information, start and expiration times, and other metadata required by pg-boss."),(0,o.kt)("p",null,"  If you need to customize the creation of the pg-boss instance, you can set an environment variable called ",(0,o.kt)("inlineCode",{parentName:"p"},"PG_BOSS_NEW_OPTIONS")," to a stringified JSON object containing ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/timgit/pg-boss/blob/7.2.1/docs/readme.md#newoptions"},"these initialization parameters"),". ",(0,o.kt)("strong",{parentName:"p"},"NOTE"),": Setting this overwrites all Wasp defaults, so you must include database connection information as well."),(0,o.kt)("h5",{id:"pg-boss-considerations"},"pg-boss considerations"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Wasp starts pg-boss alongside your web server's application, where both are simultaneously operational. This means that jobs running via pg-boss and the rest of the server logic (like Operations) share the CPU, therefore you should avoid running CPU-intensive tasks via jobs.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Wasp does not (yet) support independent, horizontal scaling of pg-boss-only applications, nor starting them as separate workers/processes/threads."))),(0,o.kt)("li",{parentName:"ul"},"The job name/identifier in your ",(0,o.kt)("inlineCode",{parentName:"li"},".wasp")," file is the same name that will be used in the ",(0,o.kt)("inlineCode",{parentName:"li"},"name")," column of pg-boss tables. If you change a name that had a ",(0,o.kt)("inlineCode",{parentName:"li"},"schedule")," associated with it, pg-boss will continue scheduling those jobs but they will have no handlers associated, and will thus become stale and expire. To resolve this, you can remove the applicable row from the ",(0,o.kt)("inlineCode",{parentName:"li"},"schedule")," table in the ",(0,o.kt)("inlineCode",{parentName:"li"},"pgboss")," schema of your database.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"If you remove a ",(0,o.kt)("inlineCode",{parentName:"li"},"schedule")," from a job, you will need to do the above as well."))),(0,o.kt)("li",{parentName:"ul"},"If you wish to deploy to Heroku, you need to set an additional environment variable called ",(0,o.kt)("inlineCode",{parentName:"li"},"PG_BOSS_NEW_OPTIONS")," to ",(0,o.kt)("inlineCode",{parentName:"li"},'{"connectionString":"<REGULAR_HEROKU_DATABASE_URL>","ssl":{"rejectUnauthorized":false}}'),". This is because pg-boss uses the ",(0,o.kt)("inlineCode",{parentName:"li"},"pg")," extension, which does not seem to connect to Heroku over SSL by default, which Heroku requires. Additionally, Heroku uses a self-signed cert, so we must handle that as well."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://devcenter.heroku.com/articles/connecting-heroku-postgres#connecting-in-node-js"},"https://devcenter.heroku.com/articles/connecting-heroku-postgres#connecting-in-node-js")))),(0,o.kt)("h3",{id:"basic-job-definition-and-usage"},"Basic job definition and usage"),(0,o.kt)("p",null,"To declare a ",(0,o.kt)("inlineCode",{parentName:"p"},"job")," in Wasp, simply add a declaration with a reference to an ",(0,o.kt)("inlineCode",{parentName:"p"},"async")," function, like the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css",metastring:'title="main.wasp"',title:'"main.wasp"'},'job mySpecialJob {\n  executor: PgBoss,\n  perform: {\n    fn: import { foo } from "@ext/jobs/bar.js"\n  }\n}\n')),(0,o.kt)("p",null,"Then, in your ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#queries-and-actions-aka-operations"},"Operations")," or ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#setupfn-extimport-optional"},"setupFn")," (or any other NodeJS code), you can submit work to be done:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'import { mySpecialJob } from \'@wasp/jobs/mySpecialJob.js\'\n\nconst submittedJob = await mySpecialJob.submit({ job: "args" })\nconsole.log(await submittedJob.pgBoss.details())\n\n// Or, if you\'d prefer it to execute in the future, just add a .delay().\n// It takes a number of seconds, Date, or ISO date string.\nawait mySpecialJob.delay(10).submit({ job: "args" })\n')),(0,o.kt)("p",null,"And that is it! Your job will be executed by the job executor (pg-boss, in this case) as if you called ",(0,o.kt)("inlineCode",{parentName:"p"},'foo({ data: { job: "args" } })'),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": pg-boss wraps job arguments into a larger object and exposes it under the property ",(0,o.kt)("inlineCode",{parentName:"p"},"data"),"."),(0,o.kt)("h3",{id:"recurring-jobs"},"Recurring jobs"),(0,o.kt)("p",null,"If you have work that needs to be done on some recurring basis, you can add a ",(0,o.kt)("inlineCode",{parentName:"p"},"schedule")," to your job declaration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css",metastring:'{6-9} title="main.wasp"',"{6-9}":!0,title:'"main.wasp"'},'job mySpecialJob {\n  executor: PgBoss,\n  perform: {\n    fn: import { foo } from "@ext/jobs/bar.js"\n  },\n  schedule: {\n    cron: "0 * * * *",\n    args: {=json { "job": "args" } json=} // optional\n  }\n}\n')),(0,o.kt)("p",null,"In this example, you do ",(0,o.kt)("em",{parentName:"p"},"not")," need to invoke anything in JavaScript. You can imagine ",(0,o.kt)("inlineCode",{parentName:"p"},'foo({ data: { "job": "args" } })')," getting automatically scheduled and invoked for you every hour."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": pg-boss wraps job arguments into a larger object and exposes it under the property ",(0,o.kt)("inlineCode",{parentName:"p"},"data"),"."),(0,o.kt)("h3",{id:"fully-specified-example"},"Fully specified example"),(0,o.kt)("p",null,"Additionally, both ",(0,o.kt)("inlineCode",{parentName:"p"},"perform")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"schedule")," accept ",(0,o.kt)("inlineCode",{parentName:"p"},"executorOptions"),", which we pass directly to the named job executor when you submit jobs. In this example, the scheduled job will have a ",(0,o.kt)("inlineCode",{parentName:"p"},"retryLimit")," set to 0, as ",(0,o.kt)("inlineCode",{parentName:"p"},"schedule")," overrides any similar property from ",(0,o.kt)("inlineCode",{parentName:"p"},"perform"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css"},'job mySpecialJob {\n  executor: PgBoss,\n  perform: {\n    fn: import { foo } from "@ext/jobs/bar.js",\n    executorOptions: {\n      pgBoss: {=json { "retryLimit": 1 } json=}\n    }\n  },\n  schedule: {\n    cron: "*/5 * * * *",\n    args: {=json { "foo": "bar" } json=},\n    executorOptions: {\n      pgBoss: {=json { "retryLimit": 0 } json=}\n    }\n  }\n}\n')),(0,o.kt)("h3",{id:"fields-3"},"Fields"),(0,o.kt)("h4",{id:"executor-jobexecutor-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"executor: JobExecutor")," (required)"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"PgBoss")," is currently our only job executor, and is recommended for low-volume production use cases. It requires your ",(0,o.kt)("inlineCode",{parentName:"p"},"app.db.system")," to be ",(0,o.kt)("inlineCode",{parentName:"p"},"PostgreSQL"),"."),(0,o.kt)("h4",{id:"perform-dict-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"perform: dict")," (required)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h5",{parentName:"li",id:"fn-fn-required"},(0,o.kt)("inlineCode",{parentName:"h5"},"fn: fn")," (required)"),(0,o.kt)("p",{parentName:"li"},"An ",(0,o.kt)("inlineCode",{parentName:"p"},"async")," JavaScript function of work to be performed. It can optionally take a JSON value as an argument.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h5",{parentName:"li",id:"executoroptions-dict-optional"},(0,o.kt)("inlineCode",{parentName:"h5"},"executorOptions: dict")," (optional)"),(0,o.kt)("p",{parentName:"li"},"Executor-specific default options to use when submitting jobs. These are passed directly through and you should consult the documentation for the job executor. These can be overridden during invocation with ",(0,o.kt)("inlineCode",{parentName:"p"},"submit()")," or in a ",(0,o.kt)("inlineCode",{parentName:"p"},"schedule"),"."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h5",{parentName:"li",id:"pgboss-json-optional"},(0,o.kt)("inlineCode",{parentName:"h5"},"pgBoss: JSON")," (optional)"),"See the docs for ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/timgit/pg-boss/blob/7.2.1/docs/readme.md#sendname-data-options"},"pg-boss"),".")))),(0,o.kt)("h4",{id:"schedule-dict-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"schedule: dict")," (optional)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h5",{parentName:"li",id:"cron-string-required"},(0,o.kt)("inlineCode",{parentName:"h5"},"cron: string")," (required)"),(0,o.kt)("p",{parentName:"li"},"A 5-placeholder format cron expression string. See rationale for minute-level precision ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/timgit/pg-boss/blob/7.2.1/docs/readme.md#scheduling"},"here"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h5",{parentName:"li",id:"args-json-optional"},(0,o.kt)("inlineCode",{parentName:"h5"},"args: JSON")," (optional)"),(0,o.kt)("p",{parentName:"li"},"The arguments to pass to the ",(0,o.kt)("inlineCode",{parentName:"p"},"perform.fn")," function when invoked."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Note"),": pg-boss wraps job arguments into a larger object and exposes it under the property ",(0,o.kt)("inlineCode",{parentName:"p"},"data"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h5",{parentName:"li",id:"executoroptions-dict-optional-1"},(0,o.kt)("inlineCode",{parentName:"h5"},"executorOptions: dict")," (optional)"),(0,o.kt)("p",{parentName:"li"},"Executor-specific options to use when submitting jobs. These are passed directly through and you should consult the documentation for the job executor. The ",(0,o.kt)("inlineCode",{parentName:"p"},"perform.executorOptions")," are the default options, and ",(0,o.kt)("inlineCode",{parentName:"p"},"schedule.executorOptions")," can override/extend those."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h5",{parentName:"li",id:"pgboss-json-optional-1"},(0,o.kt)("inlineCode",{parentName:"h5"},"pgBoss: JSON")," (optional)"),"See the docs for ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/timgit/pg-boss/blob/7.2.1/docs/readme.md#sendname-data-options"},"pg-boss"),".")))),(0,o.kt)("h3",{id:"javascript-api"},"JavaScript API"),(0,o.kt)("h4",{id:"invocation"},"Invocation"),(0,o.kt)("h5",{id:"import"},(0,o.kt)("inlineCode",{parentName:"h5"},"import")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import { mySpecialJob } from '@wasp/jobs/mySpecialJob.js'\n")),(0,o.kt)("h5",{id:"submitjobargs-executoroptions"},(0,o.kt)("inlineCode",{parentName:"h5"},"submit(jobArgs, executorOptions)")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h6",{parentName:"li",id:"jobargs-json-optional"},(0,o.kt)("inlineCode",{parentName:"h6"},"jobArgs: JSON")," (optional)")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h6",{parentName:"li",id:"executoroptions-json-optional"},(0,o.kt)("inlineCode",{parentName:"h6"},"executorOptions: JSON")," (optional)"))),(0,o.kt)("p",null,"Submits a ",(0,o.kt)("inlineCode",{parentName:"p"},"job")," to be executed by an executor, optionally passing in a JSON job argument your job handler function will receive, and executor-specific submit options."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": pg-boss wraps job arguments into a larger object and exposes it under the property ",(0,o.kt)("inlineCode",{parentName:"p"},"data"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const submittedJob = await mySpecialJob.submit({ job: "args" })\n')),(0,o.kt)("h5",{id:"delaystartafter-optional"},(0,o.kt)("inlineCode",{parentName:"h5"},"delay(startAfter)")," (optional)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("h6",{parentName:"li",id:"startafter-int--string--date-required"},(0,o.kt)("inlineCode",{parentName:"h6"},"startAfter: int | string | Date")," (required)"))),(0,o.kt)("p",null,"Delaying the invocation of the job handler. The delay can be one of:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Integer: number of seconds to delay. ","[Default 0]"),(0,o.kt)("li",{parentName:"ul"},"String: ISO date string to run at."),(0,o.kt)("li",{parentName:"ul"},"Date: Date to run at.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const submittedJob = await mySpecialJob.delay(10).submit({ job: "args" }, { "retryLimit": 2 })\n')),(0,o.kt)("h4",{id:"tracking"},"Tracking"),(0,o.kt)("p",null,"The return value of ",(0,o.kt)("inlineCode",{parentName:"p"},"submit()")," is an instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"SubmittedJob"),", which minimally contains:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"jobId"),": A getter returning the UUID String ID for the job in that executor."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"jobName"),": A getter returning the name of the job you used in your ",(0,o.kt)("inlineCode",{parentName:"li"},".wasp")," file."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"executorName"),": A getter returning a Symbol of the name of the job executor.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"For pg-boss, you can import a Symbol from: ",(0,o.kt)("inlineCode",{parentName:"li"},"import { PG_BOSS_EXECUTOR_NAME } from '@wasp/jobs/core/pgBoss/pgBossJob.js'")," if you wish to compare against ",(0,o.kt)("inlineCode",{parentName:"li"},"executorName"),".")))),(0,o.kt)("p",null,"There will also be namespaced, job executor-specific objects."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"For pg-boss, you may access: ",(0,o.kt)("inlineCode",{parentName:"li"},"pgBoss"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"NOTE"),": no arguments are necessary, as we already applied the ",(0,o.kt)("inlineCode",{parentName:"li"},"jobId")," in the available functions."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"details()"),": pg-boss specific job detail information. ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/timgit/pg-boss/blob/7.2.1/docs/readme.md#getjobbyidid"},"Reference")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cancel()"),": attempts to cancel a job. ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/timgit/pg-boss/blob/7.2.1/docs/readme.md#cancelid"},"Reference")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"resume()"),": attempts to resume a canceled job. ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/timgit/pg-boss/blob/7.2.1/docs/readme.md#resumeid"},"Reference"))))),(0,o.kt)("h2",{id:"dependencies"},"Dependencies"),(0,o.kt)("p",null,"You can specify additional npm dependencies via ",(0,o.kt)("inlineCode",{parentName:"p"},"dependencies")," field in ",(0,o.kt)("inlineCode",{parentName:"p"},"app")," declaration, in following way:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c"},'app MyApp {\n  title: "My app",\n  // ...\n  dependencies: [\n    ("redux", "^4.0.5"),\n    ("react-redux", "^7.1.3")\n  ]\n)\n')),(0,o.kt)("p",null,"You will need to re-run ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp start")," after adding a dependency for Wasp to pick it up."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"NOTE"),": In current implementation of Wasp, if Wasp is already internally using certain npm dependency with certain version specified, you are not allowed to define that same npm dependency yourself while specifying different version.\nIf you do that, you will get an error message telling you which exact version you have to use for that dependency.\nThis means Wasp dictates exact versions of certain packages, so for example you can't choose version of React you want to use.\nIn the future, we will add support for picking any version you like, but we have not implemented that yet. Check ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/issues/59"},"issue #59")," to check out the progress or contribute."),(0,o.kt)("h2",{id:"authentication--authorization"},"Authentication & Authorization"),(0,o.kt)("p",null,"Wasp provides authentication and authorization support out-of-the-box. Enabling it for your app is optional and can be done by configuring ",(0,o.kt)("inlineCode",{parentName:"p"},"auth")," field of the ",(0,o.kt)("inlineCode",{parentName:"p"},"app")," declaration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-css"},'app MyApp {\n  title: "My app",\n  // ...\n  auth: {\n    userEntity: User,\n    methods: [ EmailAndPassword ],\n    onAuthFailedRedirectTo: "/someRoute"\n  }\n}\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"app.auth")," is a dictionary with following fields:"),(0,o.kt)("h4",{id:"userentity-entity-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"userEntity: entity")," (required)"),(0,o.kt)("p",null,"Entity which represents the user (sometimes also referred to as ",(0,o.kt)("em",{parentName:"p"},"Principal"),")."),(0,o.kt)("h4",{id:"methods-authmethod-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"methods: [AuthMethod]")," (required)"),(0,o.kt)("p",null,"List of authentication methods that Wasp app supports. Currently supported methods are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"EmailAndPassword"),": Provides support for authentication with email address and a password.")),(0,o.kt)("h4",{id:"onauthfailedredirectto-string-required"},(0,o.kt)("inlineCode",{parentName:"h4"},"onAuthFailedRedirectTo: String")," (required)"),(0,o.kt)("p",null,"Path where an unauthenticated user will be redirected to if they try to access a private page (which is declared by setting ",(0,o.kt)("inlineCode",{parentName:"p"},"authRequired: true")," for a specific page).\nCheck out this ",(0,o.kt)("a",{parentName:"p",href:"/docs/tutorials/todo-app/auth#updating-main-page-to-check-if-user-is-authenticated"},"section of our Todo app tutorial")," to see an example of usage."),(0,o.kt)("h4",{id:"onauthsucceededredirectto-string-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"onAuthSucceededRedirectTo: String")," (optional)"),(0,o.kt)("p",null,'Path where a successfully authenticated user will be sent upon successful login/signup.\nDefault value is "/".'),(0,o.kt)("h3",{id:"email-and-password"},"Email and Password"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"EmailAndPassword")," authentication method makes it possible to signup/login into the app by using email address and a password.\nThis method requires that ",(0,o.kt)("inlineCode",{parentName:"p"},"userEntity")," specified in ",(0,o.kt)("inlineCode",{parentName:"p"},"auth")," contains ",(0,o.kt)("inlineCode",{parentName:"p"},"email: string")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"password: string")," fields."),(0,o.kt)("p",null,"We provide basic validations out of the box, which you can customize as shown below. Default validations are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"email"),": non-empty"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"password"),": non-empty, at least 8 characters, and contains a number")),(0,o.kt)("h4",{id:"high-level-api"},"High-level API"),(0,o.kt)("p",null,"The quickest way to get started is by using the following API generated by Wasp:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Signup and Login forms at ",(0,o.kt)("inlineCode",{parentName:"li"},"@wasp/auth/forms/Signup")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"@wasp/auth/forms/Login")," routes"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"logout")," function"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"useAuth()")," React hook")),(0,o.kt)("p",null,"Check our ",(0,o.kt)("a",{parentName:"p",href:"/docs/tutorials/todo-app/auth"},"Todo app tutorial")," to see how it works. See below for detailed specification of each of these methods."),(0,o.kt)("h4",{id:"lower-level-api"},"Lower-level API"),(0,o.kt)("p",null,"If you require more control in your authentication flow, you can achieve that in the following ways:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"If you don't want to use already generated Signup and Login forms and want to create your own, you can use ",(0,o.kt)("inlineCode",{parentName:"li"},"signup")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"login")," function by invoking them from the client."),(0,o.kt)("li",{parentName:"ul"},"If you want to execute custom code on the server during sign up, create your own sign up action which invokes Prisma client as ",(0,o.kt)("inlineCode",{parentName:"li"},"context.entities.[USER_ENTITY].create()")," function, along with your custom code.")),(0,o.kt)("p",null,"The code of your custom sign-up action would look like this (your user entity being ",(0,o.kt)("inlineCode",{parentName:"p"},"User")," in this instance):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"export const signUp = async (args, context) => {\n    // Your custom code before sign-up.\n    // ...\n    const newUser = context.entities.User.create({\n        data: { email: 'some@email.com', password: 'this will be hashed!' }\n    })\n\n    // Your custom code after sign-up.\n    // ...\n    return newUser\n}\n")),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"You don't need to worry about hashing the password yourself! Even when you are using Prisma's client directly and calling ",(0,o.kt)("inlineCode",{parentName:"p"},"create()")," with a plain-text password, Wasp put middleware in place that takes care of hashing it before storing it to the database. An additional middleware also performs field validation."))),(0,o.kt)("h5",{id:"customizing-user-entity-validations"},"Customizing user entity validations"),(0,o.kt)("p",null,"To disable/enable default validations, or add your own, you can do:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const newUser = context.entities.User.create({\n  data: { email: 'some@email.com', password: 'this will be hashed!' },\n  _waspSkipDefaultValidations: false, // can be omitted if false (default), or explicitly set to true\n  _waspCustomValidations: [\n    {\n      validates: 'password',\n      message: 'password must contain an uppercase letter',\n      validator: password => /[A-Z]/.test(password)\n    },\n  ]\n})\n")),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Validations always run on ",(0,o.kt)("inlineCode",{parentName:"p"},"create()"),", but only when the field mentioned in ",(0,o.kt)("inlineCode",{parentName:"p"},"validates")," is present for ",(0,o.kt)("inlineCode",{parentName:"p"},"update()"),". The validation process stops on the first ",(0,o.kt)("inlineCode",{parentName:"p"},"validator")," to return false. If enabled, default validations run first and validate basic properties of both the ",(0,o.kt)("inlineCode",{parentName:"p"},"'email'")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"'password'")," fields."))),(0,o.kt)("h4",{id:"specification"},"Specification"),(0,o.kt)("h3",{id:"login"},(0,o.kt)("inlineCode",{parentName:"h3"},"login()")),(0,o.kt)("p",null,"An action for logging in the user."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"login(email, password)\n")),(0,o.kt)("h4",{id:"email-string"},(0,o.kt)("inlineCode",{parentName:"h4"},"email: string")),(0,o.kt)("p",null,"Email of the user logging in."),(0,o.kt)("h4",{id:"password-string"},(0,o.kt)("inlineCode",{parentName:"h4"},"password: string")),(0,o.kt)("p",null,"Password of the user logging in."),(0,o.kt)("h4",{id:"import-statement-1"},(0,o.kt)("inlineCode",{parentName:"h4"},"import statement"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import login from '@wasp/auth/login.js'\n")),(0,o.kt)("p",null,"Login is a regular action and can be used directly from the frontend."),(0,o.kt)("h3",{id:"signup"},(0,o.kt)("inlineCode",{parentName:"h3"},"signup()")),(0,o.kt)("p",null,"An action for signing in in the user."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"signup(userFields)\n")),(0,o.kt)("h4",{id:"userfields-object"},(0,o.kt)("inlineCode",{parentName:"h4"},"userFields: object")),(0,o.kt)("p",null,"Fields of user entity which was declared in ",(0,o.kt)("inlineCode",{parentName:"p"},"auth"),"."),(0,o.kt)("h4",{id:"import-statement-2"},(0,o.kt)("inlineCode",{parentName:"h4"},"import statement"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import signup from '@wasp/auth/signup.js'\n")),(0,o.kt)("p",null,"Signup is a regular action and can be used directly from the frontend."),(0,o.kt)("h3",{id:"logout"},(0,o.kt)("inlineCode",{parentName:"h3"},"logout()")),(0,o.kt)("p",null,"An action for logging out the user."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"logout()\n")),(0,o.kt)("h4",{id:"import-statement-3"},(0,o.kt)("inlineCode",{parentName:"h4"},"import statement"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import logout from '@wasp/auth/logout.js'\n")),(0,o.kt)("h5",{id:"example-of-usage-1"},"Example of usage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import logout from '@wasp/auth/logout.js'\n\nconst SignOut = () => {\n  return (\n    <button onClick={logout}>Logout</button>\n  )\n}\n")),(0,o.kt)("h4",{id:"reset-password"},"Reset password"),(0,o.kt)("p",null,"Coming soon."),(0,o.kt)("h3",{id:"updating-users-password"},"Updating user's password"),(0,o.kt)("p",null,"If you need to update user's password, you can do it safely via Prisma client, e.g. within an action:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"export const updatePassword = async (args, context) => {\n  return context.entities.User.update({\n    where: { id: args.userId },\n    data: {\n      password: 'New pwd which will be hashed automatically!'\n    }\n  })\n}\n")),(0,o.kt)("p",null,"You don't need to worry about hashing the password yourself - if you have an ",(0,o.kt)("inlineCode",{parentName:"p"},"auth")," declaration\nin your ",(0,o.kt)("inlineCode",{parentName:"p"},".wasp")," file, Wasp already set a middleware on Prisma that makes sure whenever password\nis created or updated on the user entity, it is also hashed before it is stored to the database."),(0,o.kt)("h3",{id:"accessing-currently-logged-in-user"},"Accessing currently logged in user"),(0,o.kt)("p",null,"When authentication is enabled in a Wasp app, we need a way to tell whether a user is logged in and access its data.\nWith that, we can further implement access control and decide which content is private and which public."),(0,o.kt)("h4",{id:"on-client"},"On client"),(0,o.kt)("p",null,"On client, Wasp provides ",(0,o.kt)("inlineCode",{parentName:"p"},"useAuth")," React hook to be used within the functional components.\n",(0,o.kt)("inlineCode",{parentName:"p"},"useAuth")," is actually a thin wrapper over Wasp's ",(0,o.kt)("inlineCode",{parentName:"p"},"useQuery")," hook and returns data in the exactly same\nformat."),(0,o.kt)("h3",{id:"useauth"},(0,o.kt)("inlineCode",{parentName:"h3"},"useAuth()")),(0,o.kt)("h4",{id:"import-statement-4"},(0,o.kt)("inlineCode",{parentName:"h4"},"import statement"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import useAuth from '@wasp/auth/useAuth.js'\n")),(0,o.kt)("h5",{id:"example-of-usage-2"},"Example of usage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="ext/MainPage.js"',title:'"ext/MainPage.js"'},"import React from 'react'\n\nimport { Link } from 'react-router-dom'\nimport useAuth from '@wasp/auth/useAuth.js'\nimport logout from '@wasp/auth/logout.js'\nimport Todo from '../Todo.js'\nimport '../Main.css'\n\nconst Main = () => {\n  const { data: user } = useAuth()\n\n  if (!user) {\n    return (\n      <span>\n        Please <Link to='/login'>login</Link> or <Link to='/signup'>sign up</Link>.\n      </span>\n    )\n  } else {\n    return (\n      <>\n        <button onClick={logout}>Logout</button>\n        <Todo />\n      < />\n    )\n  }\n}\n\nexport default Main\n")),(0,o.kt)("h4",{id:"on-server"},"On server"),(0,o.kt)("p",null,"When authentication is enabled, all the operations (actions and queries) will have ",(0,o.kt)("inlineCode",{parentName:"p"},"user")," object\npresent in the ",(0,o.kt)("inlineCode",{parentName:"p"},"context")," argument. ",(0,o.kt)("inlineCode",{parentName:"p"},"context.user")," will contain all the fields from the user entity\nexcept for the password."),(0,o.kt)("h5",{id:"example-of-usage-3"},"Example of usage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="ext/actions.js"',title:'"ext/actions.js"'},"import HttpError from '@wasp/core/HttpError.js'\n\nexport const createTask = async (task, context) => {\n  if (!context.user) {\n    throw new HttpError(403)\n  }\n\n  const Task = context.entities.Task\n  return Task.create({\n    data: {\n      description: task.description,\n      user: {\n        connect: { id: context.user.id }\n      }\n    }\n  })\n}\n")),(0,o.kt)("p",null,"In order to implement access control, each operation is responsible for checking ",(0,o.kt)("inlineCode",{parentName:"p"},"context.user")," and\nacting accordingly - e.g. if ",(0,o.kt)("inlineCode",{parentName:"p"},"context.user")," is ",(0,o.kt)("inlineCode",{parentName:"p"},"undefined")," and the operation is private then user\nshould be denied access to it."),(0,o.kt)("h3",{id:"validation-error-handling"},"Validation Error Handling"),(0,o.kt)("p",null,"When creating, updating, or deleting entities, you may wish to handle validation errors. We have exposed a class called ",(0,o.kt)("inlineCode",{parentName:"p"},"AuthError")," for this purpose. This could also be combined with ",(0,o.kt)("a",{parentName:"p",href:"/docs/language/features#prisma-error-helpers"},"Prisma Error Helpers"),"."),(0,o.kt)("h4",{id:"import-statement-5"},(0,o.kt)("inlineCode",{parentName:"h4"},"import statement"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import AuthError from '@wasp/core/AuthError.js'\n")),(0,o.kt)("h5",{id:"example-of-usage-4"},"Example of usage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  try {\n    await context.entities.User.update(...)\n  } catch (e) {\n    if (e instanceof AuthError) {\n      throw new HttpError(422, 'Validation failed', { message: e.message })\n    } else {\n      throw e\n    }\n  }\n")),(0,o.kt)("h2",{id:"client-configuration"},"Client configuration"),(0,o.kt)("p",null,"You can configure the client using the ",(0,o.kt)("inlineCode",{parentName:"p"},"client")," field inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"app"),"\ndeclaration, "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c"},'app MyApp {\n  title: "My app",\n  // ...\n  client: {\n    setupFn: import mySetupFunction from "@ext/myClientSetupCode.js"\n  }\n}\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"app.client")," is a dictionary with the following fields:"),(0,o.kt)("h4",{id:"setupfn-extimport-optional"},(0,o.kt)("inlineCode",{parentName:"h4"},"setupFn: ExtImport")," (optional)"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"setupFn")," declares a JavaScript function that Wasp executes on the client\nbefore everything else. It is expected to be asynchronous, and\nWasp will await its completion before rendering the page. The function takes no\narguments, and its return value is ignored."),(0,o.kt)("p",null,"You can use this function to perform any custom setup (e.g., setting up\nclient-side periodic jobs)."),(0,o.kt)("p",null,"Here's a dummy example of such a function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="ext/myClientSetupCode.js"',title:'"ext/myClientSetupCode.js"'},"async function mySetupFunction() {\n  let count = 1;\n  setInterval(\n    () => console.log(`You have been online for ${count++} hours.`),\n    1000 * 60 * 60,\n  )\n}\n")),(0,o.kt)("h2",{id:"server-configuration"},"Server configuration"),(0,o.kt)("p",null,"Via ",(0,o.kt)("inlineCode",{parentName:"p"},"server")," field of ",(0,o.kt)("inlineCode",{parentName:"p"},"app")," declaration, you can configure behaviour of the Node.js server (one that is executing wasp operations)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c"},'app MyApp {\n  title: "My app",\n  // ...\n  server: {\n    setupFn: import mySetupFunction from "@ext/myServerSetupCode.js"\n  }\n}\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"app.server")," is a dictionary with following fields:"),(0,o.kt)("h4",{id:"setupfn-extimport-optional-1"},(0,o.kt)("inlineCode",{parentName:"h4"},"setupFn: ExtImport")," (optional)"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"setupFn")," declares a JS function that will be executed on server start. This function is expected to be async and will be awaited before server continues with its setup and starts serving any requests."),(0,o.kt)("p",null,"It gives you an opportunity to do any custom setup, e.g. setting up additional database or starting cron/scheduled jobs."),(0,o.kt)("p",null,"The javascript function should be async, takes no arguments and its return value is ignored."),(0,o.kt)("p",null,"In case you want to store some values for later use, or to be accessed by the Operations, recommended way is to store those in variables in the same module/file where you defined the javascript setup function and then expose additional functions for reading those values, which you can then import directly from Operations and use. This effectively turns your module into a singleton whose construction is performed on server start."),(0,o.kt)("p",null,"Dummy example of such function and its usage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="ext/myServerSetupCode.js"',title:'"ext/myServerSetupCode.js"'},"let someResource = undefined\n\nconst mySetupFunction = async () => {\n  // Let's pretend functions setUpSomeResource and startSomeCronJob\n  // are implemented below or imported from another file.\n  someResource = await setUpSomeResource()\n  startSomeCronJob()\n}\n\nexport const getSomeResource = () => someResource\n\nexport default mySetupFunction\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="ext/queries.js"',title:'"ext/queries.js"'},"import { getSomeResource } from './myServerSetupCode.js'\n\n...\n\nexport const someQuery = async (args, context) => {\n  const someResource = getSomeResource()\n  return queryDataFromSomeResource(args, someResource)\n}\n")),(0,o.kt)("h2",{id:"env"},".env"),(0,o.kt)("p",null,"Your project will likely be using environment variables for configuration, typically to define connection to the database, API keys for external services and similar."),(0,o.kt)("p",null,"When in production, you will typically define environment variables through mechanisms provided by your hosting provider."),(0,o.kt)("p",null,'However, when in development, you might also need to supply certain environment variables, and to avoid doing it "manually", Wasp supports ',(0,o.kt)("inlineCode",{parentName:"p"},".env")," (dotenv) file where you can define environment variables that will be used during development (they will not be used during production)."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},".env")," file has to be defined in the root of your Wasp project."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},".env")," file should not be commited to the version control - we already ignore it by default in the .gitignore file we generate when you create a new Wasp project via ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp new")," cli command."),(0,o.kt)("p",null,"Variables are defined in ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," in the form of ",(0,o.kt)("inlineCode",{parentName:"p"},"NAME=VALUE"),", for example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"DATABASE_URL=postgresql://localhost:5432\nMY_VAR=somevalue\n")),(0,o.kt)("p",null,"Any env vars defined in the ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," will be forwarded to the server-side of your Wasp project and therefore accessible in your nodejs code via ",(0,o.kt)("inlineCode",{parentName:"p"},"process.env"),", for example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"console.log(process.env.DATABASE_URL)\n")),(0,o.kt)("h2",{id:"database-configuration"},"Database configuration"),(0,o.kt)("p",null,"Via ",(0,o.kt)("inlineCode",{parentName:"p"},"db")," field of ",(0,o.kt)("inlineCode",{parentName:"p"},"app")," declaration, you can configure the database used by Wasp."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-c"},'app MyApp {\n  title: "My app",\n  // ...\n  db: {\n    system: PostgreSQL\n  }\n}\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"app.db")," is a dictionary with following fields:"),(0,o.kt)("h4",{id:"system-dbsystem"},(0,o.kt)("inlineCode",{parentName:"h4"},"system: DbSystem")),(0,o.kt)("p",null,"Database system that Wasp will use. It can be either ",(0,o.kt)("inlineCode",{parentName:"p"},"PostgreSQL")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"SQLite"),".\nIf not defined, or even if whole ",(0,o.kt)("inlineCode",{parentName:"p"},"db")," field is not present, default value is ",(0,o.kt)("inlineCode",{parentName:"p"},"SQLite"),".\nIf you add/remove/modify ",(0,o.kt)("inlineCode",{parentName:"p"},"db")," field, run ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp db migrate-dev")," to apply the changes."),(0,o.kt)("h3",{id:"sqlite"},"SQLite"),(0,o.kt)("p",null,"Default database is ",(0,o.kt)("inlineCode",{parentName:"p"},"SQLite"),", since it is great for getting started with a new project (needs no configuring), but it can be used only in development - once you want to deploy Wasp to production you will need to switch to ",(0,o.kt)("inlineCode",{parentName:"p"},"PostgreSQL")," and stick with it.\nCheck below for more details on how to migrate from SQLite to PostgreSQL."),(0,o.kt)("h3",{id:"postgresql"},"PostgreSQL"),(0,o.kt)("p",null,"When using ",(0,o.kt)("inlineCode",{parentName:"p"},"PostgreSQL")," (",(0,o.kt)("inlineCode",{parentName:"p"},"db: { system: PostgreSQL }"),"), you will need to spin up a postgres database on your own so it runs during development (when running ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp start")," or doing ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp db ...")," commands) and provide Wasp with ",(0,o.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," environment variable that Wasp will use to connect to it."),(0,o.kt)("p",null,"One of the easiest ways to do this is by spinning up postgres docker container when you need it with the shell command"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"docker run \\\n  --rm \\\n  --publish 5432:5432 \\\n  -v postgresql-data:/var/lib/postgresql/data \\\n  --env POSTGRES_PASSWORD=devpass \\\n  postgres\n")),(0,o.kt)("p",null,"and adding the line"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"DATABASE_URL=postgresql://postgres:devpass@localhost:5432/postgres\n")),(0,o.kt)("p",null,"to the ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file in the root directory of your Wasp project."),(0,o.kt)("h3",{id:"migrating-from-sqlite-to-postgresql"},"Migrating from SQLite to PostgreSQL"),(0,o.kt)("p",null,"To run Wasp app in production, you will need to switch from ",(0,o.kt)("inlineCode",{parentName:"p"},"SQLite")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"PostgreSQL"),"."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Set ",(0,o.kt)("inlineCode",{parentName:"li"},"app.db.system")," to ",(0,o.kt)("inlineCode",{parentName:"li"},"PostgreSQL")," and set ",(0,o.kt)("inlineCode",{parentName:"li"},"DATABASE_URL")," env var accordingly (as described ",(0,o.kt)("a",{parentName:"li",href:"/docs/language/features#postgresql"},"above"),")."),(0,o.kt)("li",{parentName:"ol"},"Delete old migrations, since they are SQLite migrations and can't be used with PostgreSQL: ",(0,o.kt)("inlineCode",{parentName:"li"},"rm -r migrations/"),"."),(0,o.kt)("li",{parentName:"ol"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"wasp db migrate-dev")," to apply new changes and create new, initial migration. You will need to have your postgres database running while doing this (check ",(0,o.kt)("a",{parentName:"li",href:"/docs/language/features#postgresql"},"above")," for easy way to get it running).")))}c.isMDXComponent=!0}}]);